# 会话技术

- 一次会话中包含多次请求和响应：浏览器第一次给服务器资源发送请求，会话建立，直到有一方断开为止
- 功能：在一次会话范围内的**多次**请求间**共享**数据
- 方式：按照数据存储位置区分
  - 客户端会话技术：Cookie
  - 服务器端会话技术：Session

# Cookie

- 客户端会话技术，将数据保存到客户端

- 步骤

  1. 服务器创建Cookie对象，绑定数据：`new Cookie(String name, String value) `
  2. 服务器发送Cookie对象：`response.addCookie(Cookie cookie) `
  3. 服务器获取Cookie，拿到数据：`Cookie[]  request.getCookies()`

- 实现原理：基于响应头set-cookie和请求头cookie实现

- 细节

  1. 一次可不可以发送多个cookie？
     - 可以，创建多个Cookie对象，使用response调用多次`addCookie()`发送cookie即可

  2. cookie在浏览器中保存多长时间？

     - 默认情况下，当浏览器关闭后，Cookie数据被销毁
     -  持久化存储：`setMaxAge(int seconds)`
       - 正数：将Cookie数据写到硬盘的文件中，并指定cookie存活时间，时间到后，cookie文件自动失效
       - 负数：默认情况
       -  0：删除cookie信息

  2. cookie能不能存中文？

     - 在tomcat8之前cookie中不能直接存储中文数据，需要将中文数据转码，一般采用URL编码(%E3)，8之后支持中文数据

     - 特殊字符还是不支持，建议使用URL编码存储，URL解码解析

       ```java
       URLEncoder.encode(format, "utf-8");
       URLDecoder.decode(value, "utf-8");
       ```

  3. cookie共享问题

     - 假设在一个tomcat服务器中部署了多个web项目，默认情况下cookie不能共享
     - `setPath(String path)`：设置cookie的获取范围；默认情况下，设置当前的虚拟目录；如果要共享，则可以将path设置为"/"

  4. 不同的tomcat服务器间cookie共享问题

     - `setDomain(String path=".baidu.com")`：如果设置一级域名相同，那么多个服务器之间cookie可以共享

- 特点

  1. cookie存储数据在客户端浏览器
  2. 浏览器对于单个cookie的大小有限制(4kb)，对同一个域名下的总cookie数量也有限制(20个)

- 作用

  1. cookie一般用于存储少量不太敏感的数据
  2. 在不登录的情况下，完成服务器对客户端的身份识别

# Session

- 服务器端会话技术，在一次会话的多次请求间共享数据，将数据保存在服务器端的对象中

- 步骤

  1. 获取HttpSession对象：`HttpSession session = request.getSession()`

  2. 使用HttpSession对象：

     ```java
     Object getAttribute(String name)  
     void setAttribute(String name, Object value)
     void removeAttribute(String name)
     ```

- Session的实现依赖于Cookie

- 细节

  - 服务器如何确保在一次会话中多个获取的Session对象是同一个？

    第一次获取Session时没有Cookie，会在内存中创建一个Session对象，并把其id写入cookie中传给服务器；当第二次获取Session时读取cookie获取session的id

    ```java
    Cookie c = new Cookie("JSESSIONID",session.getId());
    c.setMaxAge(60*60);
    response.addCookie(c);
    ```

  - 客户端关闭后，服务器不关闭，两次获取的session是否为同一个？

    默认情况下不是，如果需要相同，则可以创建Cookie，键为JSESSIONID，设置最大存活时间，让cookie持久化保存

  - 客户端不关闭，服务器关闭后，两次获取的session是否为同一个？

    不是同一个，但是要确保数据不丢失

    tomcat自动完成以下工作

    session的钝化：在服务器正常关闭之前，将session对象序列化到硬盘上
  
    session的活化：在服务器启动后，将session文件转化为内存中的session对象
  
  - session什么时候被销毁？
  
    服务器关闭时session对象调用invalidate()，session默认失效时间为30分钟，可以在web.xml中\<session-config>修改